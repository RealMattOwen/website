---
import { API_KEY_TICKETS } from "astro:env/server";
import { getEntry } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import Hero from "../../../sections/Hero.astro";
import ButtonLink from "../../../components/ButtonLink.astro";

export const prerender = false;

const { event, token } = Astro.params;
if (token === undefined) {
  return Astro.redirect(`/events/${event}`);
}

const entry = await getEntry("events", event);
if (entry === undefined) {
  return Astro.redirect("/404");
}

const {
  data: { id, name, dateStart, locationText },
} = entry;

const dateStartParsed = dateStart.toLocaleDateString("en-GB", {
  weekday: "long",
  year: "numeric",
  month: "2-digit",
  day: "2-digit",
  hour: "2-digit",
  minute: "2-digit",
});

const response = await fetch("https://tickets.nn1.dev/", {
  method: "PUT",
  headers: {
    Authorization: `Bearer ${API_KEY_TICKETS}`,
  },
  body: JSON.stringify({
    token,
    eventUrl: `https://nn1.dev/events/${id}/`,
    eventName: name,
    eventDate: dateStartParsed,
    eventLocation: locationText,
  }),
});

if (response.status !== 200) {
  return Astro.redirect(`/`);
}
---

<Layout
  title="Thanks | NN1 Dev Club"
  description="NN1 Dev Club is a free, quarterly meet-up for a local community of Northamptonshire-based software enthusiasts. A place to meet, collaborate and share knowledge with each other. From devs for devs!"
>
  <Hero title="All done ðŸŽ‰" description="We can't wait to see you.">
    <ButtonLink href={`/events/${id}`} text="Go back to event details" />
  </Hero>
</Layout>
