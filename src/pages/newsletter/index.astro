---
import * as Sentry from "@sentry/astro";
import Layout from "../../layouts/Layout.astro";
import Hero from "../../sections/Hero.astro";
import ButtonLink from "../../components/ButtonLink.astro";
import { API_URL_NEWSLETTER, API_HEADERS_NEWSLETTER } from "../../constants";

export const prerender = false;

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const email = data.get("email");

    const response = await fetch(API_URL_NEWSLETTER, {
      method: "POST",
      ...API_HEADERS_NEWSLETTER,
      body: JSON.stringify({
        email,
      }),
    });

    if (!response.ok) {
      throw new Error("Failed to subscribe member.");
    }

    return Astro.redirect("/newsletter");
  } catch (error) {
    Sentry.captureException(error);
    return Astro.redirect("/404");
  }
}
---

<Layout
  title="Newsletter | NN1 Dev Club"
  description="NN1 Dev Club is a free, quarterly meet-up for a local community of Northamptonshire-based software enthusiasts. A place to meet, collaborate and share knowledge with each other. From devs for devs!"
  noIndex
>
  <Hero
    title="Thanks for signing up to the newsletter"
    description="We promise never to send you annoying crap. These are just updates about the upcoming events. Of course, you can unsubscribe anytime!"
  >
    <ButtonLink text="Go back to homepage" href="/" />
  </Hero>
</Layout>
